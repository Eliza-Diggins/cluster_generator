.. _correction:

Correcting Non-Physical Behavior
================================

In many instances, non-physical behaviors can arise in the :py:class:`model.ClusterModel` instances generated by the CGP. This
is usually because of some physical consideration that was not taken into account by the modeler; however, it is often difficult (as the
modeler) to identify the issues with your model in order to correct them. On this page, we will walk you through the different non-physicalities that
commonly occur and how to fix them.

What Causes Non-Physical Behavior?
----------------------------------

The first thing that all CGP users should have a good understanding of is how different non-physicality arise in our models and
what each really means from a physical level. There are typically 2 sources of non-physicality (Type 1 and Type 2). In Type 1, the underlying Newtonian model
is not self consistent because of some feature of the profiles used to generate the model. These are the most common type of non-physicality. Type 2 non-physicalities are
an exclusive feature of MONDian clusters generated from profiles which would otherwise be suitable for use in Newtonian dynamics. We will described each of these types of
non-physicality in detail.

Type 1 Non-Physicalities
''''''''''''''''''''''''

Type 1 errors occur due to the underlying mathematics of hydrostatic equilibrium leading to inconsistent results. These are highly dependent on the method of generation
used to produce the model.

.. tab-set::

    .. tab-item:: From :math:`\rho_g + T_g`

        .. note::

            The :math:`\rho_g + T_g` approach is the most temperamental of the generation approaches; however it is also
            the most useful for matching observational properties of clusters. We therefore encourage every user to understand
            the non-physicalities described in this section.

        In the :math:`\rho_g + T_g` approach, temperature and density profiles are provided from which HSE is used to determine the gravitational field. From
        the field, we can finally determine the dynamical mass. We therefore encounter the first set of non-physicalities:

        .. admonition:: Trivial (Type 0) Non-Physicalities

            Two non-physicalities can occur in the trivial manner if :math:`\rho_g < 0` or :math:`T_g < 0` for any value of the radius.

        If both :math:`\rho_g, T_g` are self-consistent, then the gravitational field follows from HSE as

        .. math::

            \nabla \Phi = \frac{-k_b T}{m_p \eta} \left[\frac{d\ln(\rho_g)}{dr} + \frac{d\ln(T)}{dr} \right].

        If **both profiles are monotonically decreasing**, then :math:`\nabla \Phi > 0` which is consistent. The criterion for a non-physicality is (by Gauss' Law) that
        :math:`\nabla \Phi > 0`. Therefore, an inconsistency arises if the derivative factor of the expression is non-negative.

        .. admonition:: Type 1 Non-Physicalities

            There are three Type 1 non-physicalities which can arise in this case:

            - **Type 1a-1**: :math:`\nabla_r \rho_g > 0` and :math:`|\nabla_r \ln(T_g)| < |\nabla_r \ln(\rho_g)|`. (The density is increasing too fast)
            - **Type 1a-2**: :math:`\nabla_r T_g > 0` and :math:`|\nabla_r \ln(T_g)| > |\nabla_r \ln(\rho_g)|`. (The temperature is increasing too fast)
            - **Type 1a-3**: :math:`\nabla_r T_g > 0` and :math:`\nabla_r \rho_g > 0`.

        Of these, Type 1a-2 is by far the most common because in **cool-core clusters**, the temperature gradient does go positive and therefore must be
        limited.

        Assuming that the gravitational field is everywhere consistent, the resulting dynamical mass of the system is computed directly from Gauss' Law, which
        will then by manifestly positive; however it is not guaranteed to be monotonic. If :math:`\nabla \Phi \sim M/r^2`, then

        .. math::

            \nabla_r M(<r) > 0 \implies 2r\nabla_r \Phi + r^2\nabla^2\Phi > 0.

        This implies yet another (very rare) non-physicality:

        .. admonition:: Type 2a Non-Physicalities

            There is one Type 2a non-physicality which can arise in this case:

            - **Type 2a-1a**: :math:`\nabla \Phi / \nabla \Phi_0 \le f(r)` (In Newtonian: :math:`f(r) = e^{-2r}`).

        This Type 2a Non-Physicality is labeled as a Type 2 because it differs in its behavior between gravitational theories. With a monotonically increasing :math:`M(<r)`, it is guaranteed from
        this formulation that :math:`M(<r)` will exceed or equal :math:`M_g(<r)`, thus concluding the construction of the model.

    .. tab-item:: From :math:`\rho_g + \rho_{\mathrm{dyn}}`

        The :math:`\rho_g + \rho_{\mathrm{dyn}}` approach is almost entirely self consistent. Only Type 0 non-physicalities occur
        in this case.

        .. admonition:: Trivial (Type 0) Non-Physicalities

            Occur if any of the following are not true

            - :math:`\rho_g < 0`
            - :math:`\rho_{\mathrm{dyn}} < 0`
            - :math:`\rho_g > \rho_{\mathrm{dyn}}`

    .. tab-item:: From :math:`\rho_g + S_g`

        The :math:`\rho_g + S_g` approach is entirely equivalent to the :math:`\rho_g+S_g` approach. Given that

        .. math::

            S(r) = k_bT_g(r)n_e(r)^{-2/3},

        A temperature profile is immediately specified which must meet all of the criteria for the temperature profile in the :math:`\rho_g + T_g` approach.

    .. tab-item:: Without gas

        This approach is entirely self-consistent as long as the density profile provided is physical.

Type 2 Non-Physicalities
''''''''''''''''''''''''

Type 2 Non-physicalities are gravity theory specific. Due to the modularity of the gravity implementation and the capacity for the CGP to support arbitrary
gravitational theories, we will not exhaustively cover niche cases here. Documentation for each of the individual gravity theories should include a table with
the relevant possible non-physicalities.

As was described in the previous section, some fairly banal non-physicalities can be gravity theory dependent (Type 2a) but should not be interpreted as some "gravitational inconsistency." A second class of Type 2 non-physicalities exists,
namely Type 2b, which includes non-physicality driven manifestly by the behavior of specific modified gravity theories. While these instances are also niche and should be found in the gravitational theory's documentation, one such instances is ubiquitous
enough to deserve it's mention: Type 2b-1. These are called **Newtonian-MOND disequivalence errors** and occur due to the following theorem

.. admonition:: Newton - MOND Disequivalence Theorem

    Given a self-consistent galaxy cluster model characterized by some set of observables (either :math:`\rho_g + T_g` or :math:`\rho_g + S_g`), there exists no equivalent system in MONDian gravity which
    is capable of both matching the observables and being physically consistent. A characteristic bound (Diggins et. al.) may be found such that a cluster of this sort is consistent (at best) up to the
    radius at which

    .. math::

        \frac{d\ln(\tilde{M}_{\mathrm{dyn}}(<r))}{dr} \ge \frac{1}{r(\gamma^\alpha + 1)},

    where :math:`\tilde{M}` is the **Newtonian** dynamical mass, and :math:`\gamma = G\tilde{M}_{\mathrm{dyn}} / (r^2a_0)`.

We note the existence of these non-physicalities because they will, inevitably, occur anytime one tries to generate a cluster model for simulation in MOND gravity and therefore must be corrected frequently.

.. figure:: _images/diagrams/non-physical.drawio.png
    :alt: Non-physicalities diagram.

    All of the possible non-physicalities which occur in the CGP.

Fixing Non-Physical Behaviors
-----------------------------

Now that the different types of non-physicality have been established, its time to get to the good part: fixing them. Non-physicalities are tricky because they may arise
in many case specific instances that are hard to automatically correct. For that reason, ``cluster_generator`` **NEVER automatically corrects non-physical behavior**. Instead, the :py:mod:`correction` module is provided for users to
correct these problems as easily as possible without being pigeon-holed into a one size fits all solution. Here we will discuss the various options for correction of non-physical profiles.

Which Cases Can Be Fixed?
'''''''''''''''''''''''''

The good news is that most of these non-physicalities can be corrected with the tools provided. In the diagram above, those cases with a tag "ERROR" will not be fixable; however, they will also lead
to an outright error before even generating the galaxy cluster. It is assumed that any of these sort of errors are too egregious to have any root cause other than oblivious error or abject incompetence. In either case, we think its best
to warn you.
